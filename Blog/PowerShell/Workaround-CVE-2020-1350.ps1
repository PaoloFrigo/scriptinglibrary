#requires -runasadministrator  
#requires -Version 5.1 

# Paolo Frigo, https://www.scriptinglibrary.com

# https://nvd.nist.gov/vuln/detail/CVE-2020-1350
# https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1350

$RegBackupFile = "c:\windows\temp\DNS-CVE-2020-1350.reg"

#Conditions for applying the workaround DNS Role installed, DNS Server running  
$DNSServerInstalled =  [bool] (Get-WindowsFeature | Where-Object {($_.name -like "DNS") -and ($_.InstallState -eq "Installed")})
$DNSServerRunning   =  (Get-Service DNS -ErrorAction Ignore).Status -eq "Running"

function Check-Workaround(){
    try {
        if (Get-ItemPropertyValue -path "HKLM:\SYSTEM\CurrentControlSet\Services\DNS\Parameters\" -Name TcpReceivePacketSize){
            return $True  # Workaround already applied           
        }        
    }
    catch {
        Return $False #No workaround applied
    }
}

function Apply-Workaround(){
    if ($DNSServerInstalled -and $DNSServerRunning -and $($(Check-Workaround) -eq $false)){
        Write-Verbose "DNS SERVER service is Installed and Running, Workaround not found in the registry"
    
        Write-Output "Starting to Backup of the Registry ( $RegBackupFile ) before applying the workaround"
        reg export "HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters\" $RegBackupFile 
    
        New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\DNS\Parameters\" -Name TcpReceivePacketSize  -PropertyType DWORD -Value 0xFF00
        Restart-Service DNS -verbose -Confirm
        Write-Output "Workaround applied."

    } 
}

function Remove-Workaround(){
    if ($DNSServerInstalled -and $DNSServerRunning -and $($(Check-Workaround) -eq $true)){
        Write-Verbose "DNS SERVER service is Installed and Running, Workaround found in the registry"         
        Remove-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\DNS\Parameters\" -Name TcpReceivePacketSize  -Confirm
        Restart-Service DNS -verbose -Confirm
        Write-Output "Workaround removed."
    } 
}
